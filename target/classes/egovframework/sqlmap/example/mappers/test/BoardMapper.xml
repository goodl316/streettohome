<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="egovframework.sth.domain.board.mapper.BoardMapper">

	<resultMap id="BoardDTO"
		type="egovframework.sth.domain.board.domain.BoardDTO" />
	<resultMap id="AnimalDTO"
		type="egovframework.sth.domain.board.domain.AnimalDTO" />
	<resultMap
		type="egovframework.sth.domain.board.domain.BoardViewVO"
		id="BoardViewVO"></resultMap>
	<resultMap
		type="egovframework.sth.domain.board.domain.BoardVO" id="BoardVO"></resultMap>

	<insert id="insBoard" useGeneratedKeys="true" keyProperty="b_no">
		INSERT INTO board (
		b_title,b_ctnt,b_hit,b_price,b_loc_sido,b_loc_gugun,b_tt,b_enddt,b_auth,b_del,m_no
		)values
		(#{b_title},#{b_ctnt},#{b_hit},#{b_price}
		,#{b_loc_sido},#{b_loc_gugun},#{b_tt},#{b_enddt},#{b_auth},#{b_del},#{m_no})
	</insert>

	<insert id="insAnimal" useGeneratedKeys="true"
		keyProperty="an_no">
		INSERT INTO animal_info(
		b_no,an_name,an_age,an_type1,an_type2,an_img,an_ns,an_gender
		)
		values(
		#{b_no},#{an_name},#{an_age,},#{an_type1},#{an_type2},"test.jpg",#{an_ns},#{an_gender}
		)

	</insert>
	
	<insert id="insAuction">
	insert into auction(
	ac_enddt,ac_startprice,ac_price,m_no,b_no,ac_cur_winner,ac_closed
	)values(
	#{ac_enddt},#{ac_startprice},#{ac_price},#{m_no},#{b_no},#{ac_cur_winner},#{ac_closed}
	)
	</insert>

	<select id="boardList" resultMap="BoardVO">
		<choose>
			<when test=" an_type1 != null">
				SELECT
				a.b_title,a.b_no,a.b_dt,a.b_tt,a.b_loc_sido,
				a.b_loc_gugun,a.b_price,b.an_type1,
				b.an_type2,b.an_img,b.an_no
				FROM board a
				LEFT
				JOIN
				animal_info b
				ON a.b_no = b.b_no
				WHERE b.an_type1=#{an_type1}
				and a.b_del =0
				order by a.b_no DESC
				LIMIT #{firstIndex}, #{recordCountPerPage}
			</when>
			<when test="an_type1 == null">
				SELECT a.b_title,a.b_no,a.b_dt,a.b_tt,a.b_loc_sido,
				a.b_loc_gugun,a.b_price,b.an_type1,
				b.an_type2,b.an_img,b.an_no
				FROM board a
				LEFT
				JOIN
				animal_info b
				ON a.b_no = b.b_no
				WHERE
				b.an_type1 = #{type3}
				<if test='b_loc_sido != null and b_loc_sido != "" '> 
				and a.b_loc_sido=#{b_loc_sido}
				</if>
				<if test='b_loc_gugun != null and b_loc_gugun != "" '>
				and a.b_loc_gugun=#{b_loc_gugun}
				</if>
				<if test='b_tt != null and b_tt != "" '>
				and a.b_tt =#{b_tt}
				</if>
				<if test='an_type2 != null and an_type2 != "" '>
				and b.an_type2=#{an_type2}
				</if>
				<if test='an_gender != null and an_gender != "" '>
				and b.an_gender =#{an_gender}
				</if>
				<if test='b_price == 1'>
			 	<![CDATA[
					and a.b_price <= 50000
				]]>
				</if>
				<if test='b_price == 2'>
				<![CDATA[
					and a.b_price >= 50000 and a.b_price <= 200000
				]]>
				</if>
				<if test='b_price == 3'>
				<![CDATA[
					and a.b_price >= 200000 and a.b_price <= 500000
				]]>
				</if>
				<if test='b_price == 4'>
				<![CDATA[
					and a.b_price >= 500000
				]]>
				</if>
				<if test= 'b_price == 0 and b_tt == "무료" '>
				and a.b_price = 0		
				</if>
				and a.b_del = 0
				order by a.b_no DESC
				LIMIT #{firstIndex}, #{recordCountPerPage}
			</when>
		</choose>
	</select>

	<select id="countBoard" resultType="int">
		<choose>
			<when test="an_type1 != null">
				select count(*) as countBoard from board a
				left join animal_info b
				on a.b_no = b.b_no
				WHERE b.an_type1=#{an_type1}
				and a.b_del = 0
			</when>
			<when test="an_type1 == null">
				select count(*) as countBoard from board a
				left join animal_info b
				on a.b_no = b.b_no
				WHERE
				b.an_type1 = #{type3}
				<if test='an_type2 != null and an_type2 != "" '> 
				AND b.an_type2 = #{an_type2}
				</if>
				<if test='an_gender != null and an_gender != "" '>
				AND b.an_gender = #{an_gender}
				</if>
				<if test='b_price != 0'>
				AND a.b_price <![CDATA[<]]>#{b_price}
				</if>
				<if test= 'b_price == 0 and b_tt == "무료" '>
				AND a.b_price = 0		
				</if>
				<if test='b_loc_sido != null and b_loc_sido != "" '>
				AND a.b_loc_sido = #{b_loc_sido}
				</if>
				<if test='b_loc_gugun != null and b_loc_gugun != "" '>
				AND a.b_loc_gugun = #{b_loc_gugun}
				</if>
				<if test='b_tt != null and b_tt != "" '>
				AND a.b_tt = #{b_tt} 
				</if>
				and a.b_del = 0
			</when>
		</choose>
	</select>
	
	<select id="selinfo" resultMap="AnimalDTO">
	select an_no, an_img from animal_info where b_no = #{b_no}
	</select>
	<select id="modselboard" resultMap="BoardVO">
		SELECT * FROM board a
		LEFT JOIN animal_info b
		ON a.b_no = b.b_no
		WHERE a.b_no =#{b_no};
	</select>

	<select id="selBoardView" resultMap="BoardViewVO">
        SELECT B.b_no, B.b_title,
        B.b_ctnt, B.b_hit, B.b_state, B.b_price,
        B.b_loc_sido, B.b_loc_gugun, B.b_tt,
        DATE_FORMAT(B.b_enddt, '%Y-%m-%d %H:%i:%s') AS b_enddt,
        DATE_FORMAT(B.b_dt, '%Y-%m-%d %H:%i:%s') AS b_dt,
        B.m_no, B.b_auth,
        M.m_nickname AS b_writer, 
        AC.ac_startprice AS ac_startprice, AC.ac_cur_winner,
        AC.ac_price AS ac_price,
        AI.an_no AS an_no, AI.an_name AS an_name, AI.an_age AS an_age, AI.an_type1 AS an_type1,
        AI.an_type2 AS an_type2, AI.an_img AS an_img, AI.an_ns AS an_ns, AI.an_gender AS an_gender
        FROM board AS B
        LEFT JOIN member AS M
        ON B.m_no = M.m_no 
        LEFT JOIN auction AS AC
        ON B.b_no = AC.b_no
        LEFT JOIN animal_info AS AI
        ON B.b_no = AI.b_no
        WHERE B.b_no = #{b_no} AND B.b_del = 0
    </select>

	<update id="updpatImg">
		update animal_info
		set an_img = #{an_img}
		where an_no =
		#{an_no}
	</update>
	
	<update id="updateBoard">
		update board
		set b_no = b_no
		<if test='b_title !=null and b_title != ""'> 
		,b_title = #{b_title}
		</if>
		<if test='b_ctnt !=null and b_ctnt != ""'>
		,b_ctnt = #{b_ctnt}
		</if>
		<if test='b_loc_sido !=null and b_loc_sido != ""'>
		,b_loc_sido = #{b_loc_sido}
		</if>
		<if test='b_loc_gugun !=null and b_loc_gugun != ""'>
		,b_loc_gugun = #{b_loc_gugun}
		</if>
		<if test='b_tt !=null and b_tt != ""'>
		,b_tt = #{b_tt}
		</if>
		<if test='b_price !=null and b_price != ""'>
		,b_price = #{b_price}
		</if>
		where b_no = #{b_no}
	</update>
	
	<update id="updateAnimal">
		update animal_info
		set an_no =an_no
		<if test='an_name !=null and an_name != ""'> 
		,an_name = #{an_name}
		</if>
		<if test='an_gender !=null and an_gender != ""'>
		, an_gender = #{an_gender}
		</if>
		<if test='an_age !=null and an_age != ""'>
		, an_age = #{an_age}
		</if>
		<if test='an_type1 !=null and an_type1 != ""'>
		, an_type1 = #{an_type1}
		</if>
		<if test='an_type2 !=null and an_type2 != ""'>
		, an_type2 = #{an_type2}
		</if>
		<if test='an_ns !=null and an_ns != ""'>
		, an_ns = #{an_ns}
		</if>
		where b_no = #{b_no}
	</update>
	
	<update id="boardHit">
		UPDATE board
		SET b_hit = b_hit+1
		WHERE b_no = #{b_no}
	</update>
	
</mapper>
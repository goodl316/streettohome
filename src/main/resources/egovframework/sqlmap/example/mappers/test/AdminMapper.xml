<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper
	namespace="egovframework.sth.domain.admin.mapper.AdminMapper">

	<resultMap
		type="egovframework.sth.domain.admin.domain.AdminDTO" id="AdminDTO" />
	<resultMap
		type="egovframework.sth.domain.admin.domain.MemberDTO" id="MemberDTO" />
	<resultMap
		type="egovframework.sth.domain.admin.domain.AskDTO" id="AskDTO" />
	<resultMap
		type="egovframework.sth.domain.admin.domain.BoardDTO" id="BoardDTO" />
	<resultMap
		type="egovframework.sth.domain.admin.domain.BoardVO" id="BoardVO" />
	<resultMap
		type="egovframework.sth.domain.admin.domain.ReportVO" id="ReportVO" />
	<resultMap
		type="egovframework.sth.domain.admin.domain.BannerDTO" id="BannerDTO" />


	<insert id="insreport">
		insert into report
		(b_no,m_no,rp_ctnt)
		value(
		#{b_no},#{m_no},"신고사유")
	</insert>

	<insert id="sendAllMessage">
		INSERT INTO message
		(ms_title, ms_receiver, ms_sender, ms_ctnt)
		VALUES
		<choose>
			<when test="allChk == 0">
				(#{ms_title}, (SELECT m_no FROM member WHERE
				m_nickname = #{nickname}), #{ms_sender}, #{ms_ctnt})
			</when>
			<otherwise>
				<foreach collection="ms_receiver" item="item" index="index"
					separator=",">
					(#{ms_title}, #{item}, #{ms_sender}, #{ms_ctnt})
				</foreach>
			</otherwise>
		</choose>
	</insert>
	
	<select id="selBoardStatistics" resultType="egovframework.sth.domain.admin.domain.StatisticsDTO">
		SELECT 
			round((SELECT AVG(a.cnt)
			FROM(
				SELECT COUNT(b_no) AS cnt
				FROM board 
				WHERE date(b_dt) BETWEEN DATE_sub(CURDATE(), INTERVAL 30 day) AND CURDATE()
				GROUP BY date(b_dt)
			) AS a),1) AS 'today'
			,
			round((SELECT AVG(a.cnt)
			FROM(
				SELECT COUNT(b_no) AS cnt
				FROM board 
				WHERE date(b_dt) BETWEEN DATE_sub(CURDATE(), INTERVAL 30 WEEK) AND CURDATE()
				GROUP BY week(b_dt)
			) AS a),1) AS 'week'
			,
			round((SELECT AVG(a.cnt)
			FROM(
				SELECT COUNT(b_no) AS cnt
				FROM board 
				WHERE date(b_dt) BETWEEN DATE_sub(CURDATE(), INTERVAL 12 MONTH) AND CURDATE()
				GROUP BY MONTH(b_dt)
			) AS a),1) AS 'month'
			,
			round((SELECT AVG(a.cnt)
			FROM(
				SELECT COUNT(b_no) AS cnt
				FROM board 
				WHERE date(b_dt) BETWEEN DATE_sub(CURDATE(), INTERVAL 12 YEAR) AND CURDATE()
				GROUP BY YEAR(b_dt)
			) AS a),1) AS 'year'
	</select>
	
	<select id="selReplyStatistics" resultType="egovframework.sth.domain.admin.domain.StatisticsDTO">
		SELECT 
			round((SELECT AVG(a.cnt)
			FROM(
				SELECT COUNT(r_no) AS cnt
				FROM reply 
				WHERE date(r_dt) BETWEEN DATE_sub(CURDATE(), INTERVAL 30 day) AND CURDATE()
				GROUP BY date(r_dt)
			) AS a),1) AS 'today'
			,
			round((SELECT AVG(a.cnt)
			FROM(
				SELECT COUNT(r_no) AS cnt
				FROM reply
				WHERE date(r_dt) BETWEEN DATE_sub(CURDATE(), INTERVAL 30 WEEK) AND CURDATE()
				GROUP BY week(r_dt)
			) AS a),1) AS 'week'
			,
			round((SELECT AVG(a.cnt)
			FROM(
				SELECT COUNT(r_no) AS cnt
				FROM reply
				WHERE date(r_dt) BETWEEN DATE_sub(CURDATE(), INTERVAL 12 MONTH) AND CURDATE()
				GROUP BY MONTH(r_dt)
			) AS a),1) AS 'month'
			,
			round((SELECT AVG(a.cnt)
			FROM(
				SELECT COUNT(r_no) AS cnt
				FROM reply
				WHERE date(r_dt) BETWEEN DATE_sub(CURDATE(), INTERVAL 12 YEAR) AND CURDATE()
				GROUP BY YEAR(r_dt)
			) AS a),1) AS 'year'
	</select>
	
	<select id="selTranHisStatistics" resultType="egovframework.sth.domain.admin.domain.StatisticsDTO">
		SELECT 
			round((SELECT AVG(a.cnt)
			FROM(
				SELECT COUNT(b_no) AS cnt
				FROM transaction_history 
				WHERE date(th_dt) BETWEEN DATE_sub(CURDATE(), INTERVAL 30 day) AND CURDATE()
				GROUP BY date(th_dt)
			) AS a),1) AS 'today'
			,
			round((SELECT AVG(a.cnt)
			FROM(
				SELECT COUNT(b_no) AS cnt
				FROM transaction_history
				WHERE date(th_dt) BETWEEN DATE_sub(CURDATE(), INTERVAL 30 WEEK) AND CURDATE()
				GROUP BY week(th_dt)
			) AS a),1) AS 'week'
			,
			round((SELECT AVG(a.cnt)
			FROM(
				SELECT COUNT(b_no) AS cnt
				FROM transaction_history
				WHERE date(th_dt) BETWEEN DATE_sub(CURDATE(), INTERVAL 12 MONTH) AND CURDATE()
				GROUP BY MONTH(th_dt)
			) AS a),1) AS 'month'
			,
			round((SELECT AVG(a.cnt)
			FROM(
				SELECT COUNT(b_no) AS cnt
				FROM transaction_history
				WHERE date(th_dt) BETWEEN DATE_sub(CURDATE(), INTERVAL 12 YEAR) AND CURDATE()
				GROUP BY YEAR(th_dt)
			) AS a),1) AS 'year'
	</select>
	
	<select id="selSalesStatistics" resultType="egovframework.sth.domain.admin.domain.StatisticsDTO">
		SELECT 
			round((SELECT AVG(a.cnt)
			FROM(
				SELECT SUM(th_fee) AS cnt
				FROM transaction_history 
				WHERE date(th_dt) BETWEEN DATE_sub(CURDATE(), INTERVAL 30 day) AND CURDATE()
				GROUP BY date(th_dt)
			) AS a)) AS 'today'
			,
			round((SELECT AVG(a.cnt)
			FROM(
				SELECT SUM(th_fee) AS cnt
				FROM transaction_history
				WHERE date(th_dt) BETWEEN DATE_sub(CURDATE(), INTERVAL 30 WEEK) AND CURDATE()
				GROUP BY week(th_dt)
			) AS a)) AS 'week'
			,
			round((SELECT AVG(a.cnt)
			FROM(
				SELECT SUM(th_fee) AS cnt
				FROM transaction_history
				WHERE date(th_dt) BETWEEN DATE_sub(CURDATE(), INTERVAL 12 MONTH) AND CURDATE()
				GROUP BY MONTH(th_dt)
			) AS a)) AS 'month'
			,
			round((SELECT AVG(a.cnt)
			FROM(
				SELECT SUM(th_fee) AS cnt
				FROM transaction_history
				WHERE date(th_dt) BETWEEN DATE_sub(CURDATE(), INTERVAL 12 YEAR) AND CURDATE()
				GROUP BY YEAR(th_dt)
			) AS a)) AS 'year'
	</select>
	
	<select id="selTransactionHistory" resultType="egovframework.sth.global.common.excel.model.TransactionHistoryDTO">
		SELECT b_no, 
		(SELECT m_email FROM member WHERE m_no = th_buyer) AS th_buyer, 
		(SELECT m_email FROM member WHERE m_no = th_seller) AS th_seller,
		th_price, th_fee, th_dt
		FROM transaction_history
	</select>
	
	<select id="selTableInfo" resultType="egovframework.sth.domain.admin.domain.TableInfoDTO">
		SELECT COLUMN_NAME AS 'column', DATA_TYPE AS 'type', COLUMN_KEY AS 'key'
        FROM INFORMATION_SCHEMA.COLUMNS
        WHERE TABLE_SCHEMA='streettohome' AND TABLE_NAME=#{table};
	</select>
	
	<select id="selAllMember" resultType="int">
		SELECT m_no FROM member
	</select>

	<select id="selAllNickname" resultType="String">
		SELECT m_nickname FROM
		member
	</select>

	<select id="selMember" resultMap="MemberDTO">
		<choose>
			<when test="m_name == null">
				<if test="m_state !=null">
					select
					a.m_no,a.m_name,a.m_email,a.m_dt,a.m_authstate
					,(select count(*) from report where
					m_no = a.m_no) as warning
					from member a where a.m_state = #{m_state}
					and m_auth = 1 and m_authstate = 1
					ORDER BY a.m_no DESC
					LIMIT #{firstIndex}, #{recordCountPerPage}
				</if>
				<if test="m_authstate !=null">
					select
					a.m_no,a.m_name,a.m_email,a.m_dt,a.m_authstate
					,(select count(*) from report where
					m_no = a.m_no) as warning
					from member a where a.m_authstate = #{m_authstate}
					and m_auth = 1
					ORDER BY a.m_no DESC
					LIMIT #{firstIndex}, #{recordCountPerPage}
				</if>
			</when>
			<when test="m_name !=null">
				<if test="m_state !=null">
					select
					a.m_no,a.m_name,a.m_email,a.m_dt,a.m_authstate
					,(select count(*) from report where
					m_no = a.m_no) as warning
					from member a where a.m_state = #{m_state}
					and m_auth = 1 and m_name=#{m_name} and m_authstate = 1
					ORDER BY a.m_no DESC
					LIMIT #{firstIndex}, #{recordCountPerPage}
				</if>
				<if test="m_authstate !=null">
					select
					a.m_no,a.m_name,a.m_email,a.m_dt,a.m_authstate
					,(select count(*) from report where
					m_no = a.m_no) as warning
					from member a where a.m_authstate = #{m_authstate}
					and m_auth = 1 and m_name=#{m_name}
					ORDER BY a.m_no DESC
					LIMIT #{firstIndex}, #{recordCountPerPage}
				</if>
			</when>
		</choose>
	</select>

	<select id="selCountMember" resultType="int">
		SELECT COUNT(*)
		FROM member
		WHERE m_state = #{m_state} AND m_auth = 1;
	</select>

	<select id="bannerList" resultMap="BannerDTO">
		select* from banner;
	</select>
	<select id="selinfo" resultMap="BannerDTO">
		select ba_no, ba_img1 from banner
		where ba_no = #{ba_no}
	</select>

	

	<select id="selCountBoard" resultType="int">
		SELECT COUNT(*) FROM board
		as A
		LEFT JOIN animal_info B
		ON A.b_no = B.b_no
		WHERE A.b_del = 0 AND
		B.an_type1 = #{an_type1}
	</select>

	<select id="selCountDelBoard" resultType="int">
		SELECT COUNT(*) FROM
		board as A
		LEFT JOIN animal_info B
		ON A.b_no = B.b_no
		WHERE A.b_del = 1
	</select>
	
	<select id="selBoard" resultMap="BoardDTO">
	<choose>
	<when test="m_name == null">
		select
		a.b_no,a.b_title,a.b_auth,a.b_dt,a.b_tt,b.an_type1,C.m_name as b_writer from board a
		left
		join animal_info b
		on a.b_no = b.b_no
		LEFT
		JOIN member C
		on a.m_no = C.m_no
		where a.b_del =0 and b.an_type1=
		#{an_type1}
		ORDER BY a.b_no DESC
		LIMIT #{firstIndex},
		#{recordCountPerPage}
		</when>
		<when test="m_name != null">
		select
		a.b_no,a.b_title,a.b_auth,a.b_dt,a.b_tt,b.an_type1,C.m_name as b_writer from board a
		left
		join animal_info b
		on a.b_no = b.b_no
		LEFT
		JOIN member C
		on a.m_no = C.m_no
		where a.b_del =0 and b.an_type1=
		#{an_type1} and C.m_name =#{m_name}
		ORDER BY a.b_no DESC
		LIMIT #{firstIndex},
		#{recordCountPerPage}
		</when>
		</choose>
	</select>

	<select id="delBoardList" resultMap="BoardDTO">
	<choose>
	<when test="m_name == null">
		select
		a.b_no,a.b_title,a.b_auth,a.b_dt,a.b_tt,b.an_type1,C.m_name AS
		b_writer
		from board AS a
		left
		join animal_info b
		on a.b_no = b.b_no
		LEFT
		JOIN member C
		on a.m_no = C.m_no
		where a.b_del =1 
		ORDER BY a.b_no DESC
		LIMIT #{firstIndex}, #{recordCountPerPage}
		</when>
		<when test="m_name != null">
		select
		a.b_no,a.b_title,a.b_auth,a.b_dt,a.b_tt,b.an_type1,C.m_name AS
		b_writer
		from board AS a
		left
		join animal_info b
		on a.b_no = b.b_no
		LEFT
		JOIN member C
		on a.m_no = C.m_no
		where a.b_del =1 and C.m_name=#{m_name}
		ORDER BY a.b_no DESC
		LIMIT #{firstIndex}, #{recordCountPerPage}
		</when>
		</choose>
	</select>

	<select id="selReport" resultMap="ReportVO">
		<if test="an_type1 == null">
			select a.rp_no,a.b_no,a.rp_del,a.rp_dt,
			(select m_name from
			member where m_no=a.m_no) as wr_no,
			a.rp_ctnt,b.b_title,
			c.an_type1
			from
			report a
			left
			join board b
			on a.b_no = b.b_no
			left join animal_info c
			on a.b_no =
			c.b_no
			left join member d
			on a.m_no = d.m_no
			where a.rp_del =
			0
			ORDER BY a.rp_no DESC
		</if>
		<if test="an_type1 != null ">
			select a.rp_no,a.b_no,a.rp_del,a.rp_dt,
			(select m_name from
			member where m_no=a.m_no) as wr_no,
			a.rp_ctnt,b.b_title,
			c.an_type1,d.m_name from
			report
			a
			left join board b
			on a.b_no = b.b_no
			left join animal_info c
			on a.b_no
			= c.b_no
			left join member d
			on a.m_no =
			d.m_no;
			where c.an_type1 =
			#{an_type1} and a.rp_del = 0
			ORDER BY a.rp_no
			DESC
		</if>
	</select>
	<select id="selAskList" resultMap="AskDTO">
		select
		a.ak_no,a.ak_title,a.ak_ctnt,a.ak_dt,a.m_no,b.m_name from ask a
		left
		join member b
		on a.m_no = b.m_no
		where a.ak_del = 0
	</select>

	<select id="selAsk" resultMap="AskDTO">
		select
		a.ak_no,a.ak_title,a.ak_ctnt,a.ak_dt,b.m_name,b.m_email from ask a
		left join member b
		on a.m_no = b.m_no
		where ak_no = #{ak_no}
	</select>

	<update id="delBoard">
		update board
		set b_del = 1
		where b_no = #{b_no}
	</update>
	<update id="delMember">
		update member
		set m_authstate = 3
		where m_no = #{m_no}
	</update>

	<update id="liftBan">
		update member
		set m_authstate = 1
		where m_no = #{m_no}

	</update>


	<update id="delAsk">
		update ask
		set ak_del =1
		where ak_no = #{ak_no}
	</update>

	<update id="updBannerImg">
		update banner
		set ba_img1 = #{ba_img1}
		where ba_no =
		#{ba_no};
	</update>

	<update id="delReport">
		update report
		set rp_del = 1
		where rp_no;
	</update>
	
	<update id="okBoard">
	update board
	set b_auth = 1
	where b_no = #{b_no}
	</update>
	
	<update id="nonOk">
	update board
	set b_auth = 0
	where b_no = #{b_no}
	</update>


</mapper>